#!/bin/bash

declare DEC_TCP
declare DEC_UDP

if [ $# -ne 2 ]; then
        echo "[*] The script needs a name and a target IP"
        echo "[*] Usage: $0 <name> and <target-IP ADDRESS>"
        exit 0
fi

SCAN_NAME=$1
IP_ADDR=$2

if [ ! -d ./${SCAN_NAME}/nmap ]; then
	mkdir -p ./${SCAN_NAME}/nmap
fi

tabber () {
WID=$(xprop -root | grep "_NET_ACTIVE_WINDOW(WINDOW)"| awk '{print $5}')
xdotool windowfocus $WID
xdotool key ctrl+shift+t
wmctrl -i -a $WID
sleep 1;
xdotool type --delay 1 --clearmodifiers "$1 $2 $3";
xdotool key Return;
}

# SOmetimes unicornscan is not working..
#
#echo "We run a quick Unicorn scan.."
##echo ""
#us -mU -Iv ${IP_ADDR}:a -r 3000 -R 3 | tee -a  ./${SCAN_NAME}/nmap/US_UDP_RESULTS && us -mT -Iv ${IP_ADDR}:a -r 3000 -R 3 | tee -a  ./${SCAN_NAME}/nmap/US_TCP_RESULTS
#

#echo "Do you want a TOP1000 or a full TCP port scan? [t/f]"
#read DEC_TCP

#if [[ $DEC_TCP == f ]]; then

nmap -v -Pn -sC -sV -sS -p0-65535 ${IP_ADDR} -oN ./${SCAN_NAME}/nmap/TCPscan_full  

echo ""
echo "[+++++++++++++++++++++++++++++++++++++++++++++++]"
echo "[+] NMAP -- The following TCP ports are open: [+] "
echo "[+++++++++++++++++++++++++++++++++++++++++++++++]"
echo ""

cat ./${SCAN_NAME}/nmap/TCPscan_full | grep "^[0-9]*/tcp" | tee ./${SCAN_NAME}/nmap/UNIQUE__SERVICES
echo ""

#elif [[ $DEC_TCP == t ]]; then
#nmap -v -Pn -sC -sV -sS -O --osscan-guess --reason --open --version-all ${SCAN_NAME} -oN ./${SCAN_NAME}/nmap/${SCAN_NAME}_TCPscan_1000
#
#echo ""
#echo "[+++++++++++++++++++++++++++++++++++]"
#echo "[+]The following TCP ports are open: "
#echo "[+++++++++++++++++++++++++++++++++++]"
#echo ""
#
#cat ./${SCAN_NAME}/nmap/${SCAN_NAME}_TCPscan_1000 | grep "^[0-9]*/tcp" | tee ./${SCAN_NAME}/nmap/UNIQUE__SERVICES
#echo ""
#
#fi

#if [ -e ./${SCAN_NAME}/nmap/US_UDP_RESULTS ];then
#	cat ./${SCAN_NAME}/nmap/US_TCP_RESULTS ./${SCAN_NAME}/nmap/US_UDP_RESULTS > ./${SCAN_NAME}/nmap/US_RESULTS
#	echo ""
#	echo "+++++++++++++++++++++++++++++++++++++++++++++"
#	echo "+ US -- The following ports are open results:"
#	echo "+++++++++++++++++++++++++++++++++++++++++++++"
#	echo ""
#	cat ./${SCAN_NAME}/nmap/US_RESULTS | grep "\["
#	echo ""
#else
#	echo ""
#	echo "+++++++++++++++++++++++++++++++++++++++++++++++++++++++++"
#	echo "+ US -- The following ports are open (no UDP port found):"
#	echo "+++++++++++++++++++++++++++++++++++++++++++++++++++++++++"
#	echo ""
#	cat ./${SCAN_NAME}/nmap/US_TCP_RESULTS
#fi 
#
#if [[ "$(grep -cim1 "UDP open" ./${SCAN_NAME}/nmap/US_RESULTS)" -ge 1 ]];then
#
#echo ""
#echo "++++++++++++++++++++++++++++++++++++"
#echo "+ We scan the identified UDP ports.."
#echo "++++++++++++++++++++++++++++++++++++"
#echo ""

#$(cat US_UDP_RESULTS | grep from | cut -d "[" -f 2 | cut -d "]" -f 1 | tr -d ' '| tr '\n' ','| sed 's/.$//')

echo ""
echo "[+++++++++++++++++++++++++++++++++++++++++++++++]"
echo "[+] NMAP -- Let's run a quick top100 UDP scan [+] "
echo "[+++++++++++++++++++++++++++++++++++++++++++++++]"
echo ""

nmap -v -Pn -sU --top-ports 100 ${IP_ADDR} -oN ./${SCAN_NAME}/nmap/UDPscan


#if [[ "$(grep -cim1 "UDP open" ./${SCAN_NAME}/nmap/US_RESULTS)" -ge 1 ]];then
if [[ "$(grep -cim1 "^[0-9]*/udp" ./${SCAN_NAME}/nmap/UDPscan)" -ge 1 ]];then

echo "[++++++++++++++++++++++++++++++++++++++++++++++++]"
echo "[+]The following UDP ports are open (top 100): [+]"
echo "[++++++++++++++++++++++++++++++++++++++++++++++++]"
echo ""

cat ./${SCAN_NAME}/nmap/UDPscan | grep "^[0-9]*/udp" | tee -a ./${SCAN_NAME}/nmap/UNIQUE__SERVICES

else

echo ""
echo "[++++++++++++++++++++++++]"
echo "[+]No top100 UDP ports [+]"
echo "[++++++++++++++++++++++++]"
echo ""

fi

echo ""
echo "[++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++]"
echo "[+ In total the following ports were identified for ${SCAN_NAME}:"
echo "[++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++]"
echo ""

cat ./${SCAN_NAME}/nmap/UNIQUE__SERVICES


echo ""
echo "[+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++]"
echo "[+ For the completness we run the full UDP scan in the background [+]"
echo "[+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++]"
echo ""
sleep 3

gnome-terminal --tab --title="FULL UDP SCAN" -- /bin/bash -c "nmap -v -Pn -sU -p- '${IP_ADDR}' --oN ./'${SCAN_NAME}'/nmap/UDPscan_full; cat ./'${SCAN_NAME}'/nmap/UDPscan_full | grep \"^[0-9]*/udp\" | tee -a ./'${SCAN_NAME}'/nmap/UNIQUE__SERVICES;exec bash"
