#!/bin/bash

declare SCAN_NAME
declare DEC

if [ -z "$1" ]; then
        echo "[*] The scripter needs a target.."
        echo "[*] Usage: $0 <target-IP ADDRESS>"
        exit 0
fi

SCAN_NAME=$1

##########      >>>HOUSEKEEPING<<<   ##########

if [ -e /root/NMAP/${SCAN_NAME}.d/UNIQUE__SERVICES ];then
        echo "Removing the previous temp files.."
        rm -f /root/NMAP/${SCAN_NAME}.d/UNIQUE*
        rm -f /root/NMAP/${SCAN_NAME}.d/SCRIPT*
        rm -f /root/NMAP/${SCAN_NAME}.d/NSE*
fi


if [ -a "/root/NMAP/${SCAN_NAME}.d/${SCAN_NAME}_TCP_full.nmap" ]
then
        echo "------------------------------------------------------------"
        echo "Checking the services from >>> ALL 65535 TCP <<< scanned ports.."
        echo "------------------------------------------------------------"
        echo ""
        touch /root/NMAP/${SCAN_NAME}.d/UNIQUE__SERVICES_temp

        for name in $( cat /root/NMAP/${SCAN_NAME}.d/${SCAN_NAME}_TCP_full.nmap | grep "tcp" | awk -F " " '{print $3}' );do
                echo $name >> /root/NMAP/${SCAN_NAME}.d/UNIQUE__SERVICES_temp
        done

fi

cat /root/NMAP/${SCAN_NAME}.d/UNIQUE__SERVICES_temp | cut -d "-" -f1 > /root/NMAP/${SCAN_NAME}.d/UNIQUE__SERVICES
cat /root/NMAP/${SCAN_NAME}.d/${SCAN_NAME}_TCP_full.nmap | grep "tcp" | cut -d "/" -f 1 > /root/NMAP/${SCAN_NAME}.d/UNIQUE__PORT_NUMS_temp
#For nmap7.25 it is not required to specify the port number for a script
paste /root/NMAP/${SCAN_NAME}.d/UNIQUE__SERVICES /root/NMAP/${SCAN_NAME}.d/UNIQUE__PORT_NUMS_temp > /root/NMAP/${SCAN_NAME}.d/SCRIPT_ARGS

echo "****************************************"
echo "The following services were identified: "
echo "----------------------------------------"
cat /root/NMAP/${SCAN_NAME}.d/UNIQUE__SERVICES_temp
echo "----------------------------------------"
sleep 3

for services in $(cat /root/NMAP/${SCAN_NAME}.d/UNIQUE__SERVICES);do
        ls /usr/share/nmap/scripts | grep -w $services >> /root/NMAP/${SCAN_NAME}.d/NSE_SCRIPTS
done

echo "****************************************"
echo "The following scripts were find: "
echo "----------------------------------------"
cat /root/NMAP/${SCAN_NAME}.d/NSE_SCRIPTS
echo "----------------------------------------"
