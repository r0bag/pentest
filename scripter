#!/bin/bash

declare SCAN_NAME

if [ -z "$1" ]; then
        echo "[*] The scripter needs a target.."
        echo "[*] Usage: $0 <target-IP ADDRESS>"
        exit 0
fi

SCAN_NAME=$1

#####   >>>HOUSEKEEPING<<<   #####

if [ -e /root/NMAP/${SCAN_NAME}.d/UNIQUE__SERVICES ];then
        echo "Removing the previous temp files.."
        rm -f /root/NMAP/${SCAN_NAME}.d/UNIQUE*
        rm -f /root/NMAP/${SCAN_NAME}.d/SCRIPT*
fi


if [ -a "/root/NMAP/${SCAN_NAME}.d/${SCAN_NAME}_TCP_full.nmap" ]
then
        echo "------------------------------------------------------------"
        echo "Checking the services from >>> ALL 65535 <<< scanned ports.."
        echo "------------------------------------------------------------"
        echo ""
        touch /root/NMAP/${SCAN_NAME}.d/UNIQUE__SERVICES_temp

        for name in $( cat /root/NMAP/${SCAN_NAME}.d/${SCAN_NAME}_TCP_full.nmap | grep "tcp" | awk -F " " '{print $3}' );do
                echo $name >> /root/NMAP/${SCAN_NAME}.d/UNIQUE__SERVICES_temp
        done

fi

cat /root/NMAP/${SCAN_NAME}.d/UNIQUE__SERVICES_temp | cut -d "-" -f1 > /root/NMAP/${SCAN_NAME}.d/UNIQUE__SERVICES
cat /root/NMAP/${SCAN_NAME}.d/${SCAN_NAME}_TCP_full.nmap | grep "tcp" | cut -d "/" -f 1 > /root/NMAP/${SCAN_NAME}.d/UNIQUE__PORT_NUMS_temp
paste /root/NMAP/${SCAN_NAME}.d/UNIQUE__SERVICES /root/NMAP/${SCAN_NAME}.d/UNIQUE__PORT_NUMS_temp > /root/NMAP/${SCAN_NAME}.d/SCRIPT_ARGS

########### LOOKING FOR THE SCRIPTS ############


NUM_LINES=`wc -l /root/NMAP/${SCAN_NAME}.d/SCRIPT_ARGS | cut -d " " -f1`
for ((a=1; a <= NUM_LINES ; a++))do
        echo "nmap -g 53 -Pn -n -sS --open -p$(cat /root/NMAP/${SCAN_NAME}.d/SCRIPT_ARGS | cut -f2| sed -n ''$a''p) $1 --script=banner,\"(not default and not brute) and $(cat /root/NMAP/${SCAN_NAME}.d/SCRIPT_ARGS | cut -f1 | sed -n ''$a''p)-*\""
        echo ""
        nmap -g 53 -Pn -n -sS --open -p$(cat /root/NMAP/${SCAN_NAME}.d/SCRIPT_ARGS | cut -f2| sed -n ''$a''p) $1 --script=banner,\"(not default and not brute) and $(cat /root/NMAP/${SCAN_NAME}.d/SCRIPT_ARGS | cut -f1 | sed -n ''$a''p)-*\"
done
