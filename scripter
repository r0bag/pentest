#!/bin/bash

declare SCAN_NAME
declare DEC

if [ -z "$1" ]; then
        echo "[*] The scripter needs a target.."
        echo "[*] Usage: $0 <target-IP ADDRESS>"
        exit 0
fi

SCAN_NAME=$1

##########	>>>HOUSEKEEPING<<<   ##########

if [ -e /root/NMAP/${SCAN_NAME}.d/UNIQUE__SERVICES ];then
	echo "Removing the previous temp files.."
	rm -f /root/NMAP/${SCAN_NAME}.d/UNIQUE* 
	rm -f /root/NMAP/${SCAN_NAME}.d/SCRIPT*
	rm -f /root/NMAP/${SCAN_NAME}.d/NSE*
fi


if [ -e "/root/NMAP/${SCAN_NAME}.d/${SCAN_NAME}_TCPscan_full" ]
then
	echo "------------------------------------------------------------"
	echo "Checking the services from >>> ALL 65535 TCP <<< scanned ports.."
	echo "------------------------------------------------------------"
	echo ""
	touch /root/NMAP/${SCAN_NAME}.d/UNIQUE__SERVICES_temp

	cat /root/NMAP/${SCAN_NAME}.d/${SCAN_NAME}_TCPscan_full | grep "^[0-9]*/tcp" > /root/NMAP/${SCAN_NAME}.d/UNIQUE__SERVICES_temp

else
	echo "There is no *.TCPscan_full file in the directory"
	break
fi


cat /root/NMAP/${SCAN_NAME}.d/UNIQUE__SERVICES_temp | awk -F " " '{print $3}' | cut -d "/" -f1 | cut -d "-" -f 1 | sed 's/[!@#$%^&*()_+"?]//g' > /root/NMAP/${SCAN_NAME}.d/UNIQUE__SERVICES
cat /root/NMAP/${SCAN_NAME}.d/UNIQUE__SERVICES_temp | cut -d "/" -f 1 > /root/NMAP/${SCAN_NAME}.d/UNIQUE__PORT_NUMS_temp	
#For nmap7.25 it is not required to specify the port number for a script
paste /root/NMAP/${SCAN_NAME}.d/UNIQUE__SERVICES /root/NMAP/${SCAN_NAME}.d/UNIQUE__PORT_NUMS_temp > /root/NMAP/${SCAN_NAME}.d/SCRIPT_ARGS

echo "****************************************"
echo "The following services were identified: "
echo "****************************************"
cat /root/NMAP/${SCAN_NAME}.d/UNIQUE__SERVICES_temp
echo "----------------------------------------"
sleep 3

for services in $(cat /root/NMAP/${SCAN_NAME}.d/UNIQUE__SERVICES);do
	ls /usr/share/nmap/scripts | grep -w $services >> /root/NMAP/${SCAN_NAME}.d/NSE_SCRIPTS
done

echo "****************************************"
echo "The following scripts were find: "
echo "----------------------------------------"
cat /root/NMAP/${SCAN_NAME}.d/NSE_SCRIPTS
echo "----------------------------------------"
sleep 3

#read -p "Do you want to delete some of the scripts?[y/n]" -n 1 -r
#echo
#if [ "$DEC" =~^(yes|y| ) ]; then
#	read -p "Which lines do you want to delete? [1,2,3 or 1-3]"
#	
#	echo


echo "****************************************"
echo ">>>>> The below scripts will be run, cros-check them with running services, the parser could missed smth <<<<<"
echo ">>>>> NO BRUTEFORCING was launched, if you have time/capacity for it, run it separately by modifying the nmap/nse commands <<<<<"
echo "----------------------------------------"
NUM_LINES=`wc -l /root/NMAP/${SCAN_NAME}.d/SCRIPT_ARGS | cut -d " " -f1`
for ((a=1; a <= NUM_LINES ; a++))do
	echo "nmap -p$(cat /root/NMAP/${SCAN_NAME}.d/SCRIPT_ARGS | cut -f2 | sed -n ''$a''p) $1 --script=banner,\"(not default and not brute) and $(cat /root/NMAP/${SCAN_NAME}.d/SCRIPT_ARGS | cut -f1 | sed -n ''$a''p)-*\""
	echo ""
done

echo "****************************************"
echo "Launching the scripts..."	
echo "****************************************"

touch /root/NMAP/${SCAN_NAME}.d/SCRIPT_RESULTS

NUM_LINES=`wc -l /root/NMAP/${SCAN_NAME}.d/SCRIPT_ARGS | cut -d " " -f1`
for ((a=1; a <= NUM_LINES ; a++))do
        nmap -p$(cat /root/NMAP/${SCAN_NAME}.d/SCRIPT_ARGS | cut -f2 | sed -n ''$a''p) $1 --script=banner,"(not default and not brute) and $(cat /root/NMAP/${SCAN_NAME}.d/SCRIPT_ARGS | cut -f1 | sed -n ''$a''p)-*" | tee -a  /root/NMAP/${SCAN_NAME}.d/SCRIPT_RESULTS & 
done 


echo "****************************************"
echo "The results from the scripts: "
echo "****************************************"
cat /root/NMAP/${SCAN_NAME}.d/SCRIPT_RESULTS | grep \|
