#!/bin/bash

declare DEC_TCP
declare DEC_UDP

if [ -z "$1" ]; then
        echo "[*] The scanning needs a target.."
        echo "[*] Usage: $0 <target-IP ADDRESS>"
        exit 0
fi

SCAN_NAME=$1

if [ ! -d /root/NMAP/${SCAN_NAME}.d ]; then
	mkdir /root/NMAP/${SCAN_NAME}.d
fi

tabber () {
WID=$(xprop -root | grep "_NET_ACTIVE_WINDOW(WINDOW)"| awk '{print $5}')
xdotool windowfocus $WID
xdotool key ctrl+shift+t
wmctrl -i -a $WID
sleep 1;
xdotool type --delay 1 --clearmodifiers "$1 $2 $3";
xdotool key Return;
}

echo "We run a quick Unicorn scan.."
#echo ""
us -mU -Iv ${SCAN_NAME}:a -r 3000 -R 3 | tee -a  /root/NMAP/${SCAN_NAME}.d/US_UDP_RESULTS && us -mT -Iv ${SCAN_NAME}:a -r 3000 -R 3 | tee -a  /root/NMAP/${SCAN_NAME}.d/US_TCP_RESULTS

#echo "Do you want a TOP1000 or a full TCP port scan? [t/f]"
#read DEC_TCP

#if [[ $DEC_TCP == f ]]; then

nmap -v -Pn -sC -sV -sS -O --osscan-guess -p0-65535 --reason --open --version-all ${SCAN_NAME} -oN /root/NMAP/${SCAN_NAME}.d/${SCAN_NAME}_TCPscan_full  

echo ""
echo "[++++++++++++++++++++++++++++++++++++++++++++]"
echo "[+] NMAP -- The following TCP ports are open: "
echo "[++++++++++++++++++++++++++++++++++++++++++++]"
echo ""

cat /root/NMAP/${SCAN_NAME}.d/${SCAN_NAME}_TCPscan_full | grep "^[0-9]*/tcp" | tee /root/NMAP/${SCAN_NAME}.d/UNIQUE__SERVICES
echo ""

#elif [[ $DEC_TCP == t ]]; then
#nmap -v -Pn -sC -sV -sS -O --osscan-guess --reason --open --version-all ${SCAN_NAME} -oN /root/NMAP/${SCAN_NAME}.d/${SCAN_NAME}_TCPscan_1000
#
#echo ""
#echo "[+++++++++++++++++++++++++++++++++++]"
#echo "[+]The following TCP ports are open: "
#echo "[+++++++++++++++++++++++++++++++++++]"
#echo ""
#
#cat /root/NMAP/${SCAN_NAME}.d/${SCAN_NAME}_TCPscan_1000 | grep "^[0-9]*/tcp" | tee /root/NMAP/${SCAN_NAME}.d/UNIQUE__SERVICES
#echo ""
#
#fi

if [ -e /root/NMAP/${SCAN_NAME}.d/US_UDP_RESULTS ];then
	cat /root/NMAP/${SCAN_NAME}.d/US_TCP_RESULTS /root/NMAP/${SCAN_NAME}.d/US_UDP_RESULTS > /root/NMAP/${SCAN_NAME}.d/US_RESULTS
	echo ""
	echo "+++++++++++++++++++++++++++++++++++++++++++++"
	echo "+ US -- The following ports are open results:"
	echo "+++++++++++++++++++++++++++++++++++++++++++++"
	echo ""
	cat /root/NMAP/${SCAN_NAME}.d/US_RESULTS | grep "\["
	echo ""
else
	echo ""
	echo "+++++++++++++++++++++++++++++++++++++++++++++++++++++++++"
	echo "+ US -- The following ports are open (no UDP port found):"
	echo "+++++++++++++++++++++++++++++++++++++++++++++++++++++++++"
	echo ""
	cat /root/NMAP/${SCAN_NAME}.d/US_TCP_RESULTS
fi 

if [[ "$(grep -cim1 "UDP open" /root/NMAP/${SCAN_NAME}.d/US_RESULTS)" -ge 1 ]];then

echo ""
echo "++++++++++++++++++++++++++++++++++++"
echo "+ We scan the identified UDP ports.."
echo "++++++++++++++++++++++++++++++++++++"
echo ""

#$(cat US_UDP_RESULTS | grep from | cut -d "[" -f 2 | cut -d "]" -f 1 | tr -d ' '| tr '\n' ','| sed 's/.$//')

nmap -v -Pn -sC -sV -sU -O --osscan-guess -p$(cat /root/NMAP/${SCAN_NAME}.d/US_UDP_RESULTS | grep from | cut -d "[" -f 2 | cut -d "]" -f 1 | tr -d ' '| tr '\n' ','| sed 's/.$//') --reason --open --version-all ${SCAN_NAME} -oN /root/NMAP/${SCAN_NAME}.d/${SCAN_NAME}_UDPscan

fi

if [[ "$(grep -cim1 "UDP open" /root/NMAP/${SCAN_NAME}.d/US_RESULTS)" -ge 1 ]];then

echo "[+++++++++++++++++++++++++++++++++++]"
echo "[+]The following UDP ports are open: "
echo "[+++++++++++++++++++++++++++++++++++]"
echo ""

cat /root/NMAP/${SCAN_NAME}.d/${SCAN_NAME}_UDPscan | grep "^[0-9]*/udp" | tee -a /root/NMAP/${SCAN_NAME}.d/UNIQUE__SERVICES

fi


echo ""
echo "[++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++]"
echo "[+ In total the following ports were identified for $1:"
echo "[++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++]"
echo ""

cat /root/NMAP/${SCAN_NAME}.d/UNIQUE__SERVICES


echo ""
echo "[++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++]"
echo "[+ For the completness we run the full UDP scan in the background"
echo "[++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++]"
echo ""
sleep 3
gnome-terminal -x sh -c "nmap -v -Pn -sC -sV -sU -O --osscan-guess -p0-65535 --reason --open ${SCAN_NAME} -oN /root/NMAP/${SCAN_NAME}.d/${SCAN_NAME}_UDPscan_full; cat /root/NMAP/${SCAN_NAME}.d/${SCAN_NAME}_UDPscan_full | grep \"^[0-9]*/udp\" | tee -a /root/NMAP/${SCAN_NAME}.d/UNIQUE__SERVICES; bash" 2>/dev/null



